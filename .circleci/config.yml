version: 2.1

executors:
  node-executor:
    docker:
      - image: cypress/browsers:latest # Cypress Docker image with Node.js and browsers

jobs:
  build:
    executor: node-executor
    steps:
      - checkout  # Checkout the code from your GitHub repo

      # Install dependencies
      - run:
          name: Install Dependencies
          command: |
              npm install --legacy-peer-deps
              java -version || echo "Java is not installed"
             # apt-get update
             # apt-get install -y openjdk-11-jdk
             # export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
             # export PATH=$JAVA_HOME/bin:$PATH

      # Run Cypress tests
      - run:
          name: Run Cypress Tests
          command: |
              [ -d "allure-results" ] && rm -rf "allure-results"
              [ -d "allure-report" ] && rm -rf "allure-report"
              npm run testcases:tag || true
              npm run allure:report 
              node ./scripts/zipScript.js
              ls -l ./zipReport
      
      # Store Cypress test videos as artifacts
      - store_artifacts:
          path: /root/project/cypress/videos  # Path where Cypress stores videos
          destination: cypress-videos  # The name that will be shown in CircleCI's Artifacts tab

      - store_artifacts:
          path: /root/project/cypress/screenshots  
          destination: cypress-screenshots 

      - store_artifacts:
          path: zipReport  
          destination: zipped-report     

      - store_test_results:
          path: /root/project/cypress/results  # Path where Cypress test results are stored
          destination: cypress-test-results        

workflows:
  version: 2
  test:
    jobs:
      - build  # Run the build job, which includes running Cypress and storing artifacts
